unit ColMgrMainForm;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.Phys.FB,
  FireDAC.Phys.FBDef, FireDAC.VCLUI.Wait, Data.DB, FireDAC.Comp.Client,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt, Vcl.Grids,
  Vcl.DBGrids, Vcl.ExtCtrls, FireDAC.Comp.DataSet, Vcl.StdCtrls, Vcl.Menus,
  PopupForm;

type
  TFormColMgrMain = class(TForm)
    ConWB: TFDConnection;
    QryWB: TFDQuery;
    DtsWB: TDataSource;
    PnlBottom: TPanel;
    PnlTop: TPanel;
    GrdWB: TDBGrid;
    BtnAutoFormat: TButton;
    BtnShowFields: TButton;
    PopupFieldList: TPopupMenu;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure BtnAutoFormatClick(Sender: TObject);
    procedure BtnShowFieldsClick(Sender: TObject);
  private
    HiddenFields: TStringList;
    function FindGridColumn(const AFieldName: string): Integer;
    function GetPercentFilled(FieldIndex: Integer): Double;
    function GetTotalRows: Integer;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormColMgrMain: TFormColMgrMain;

implementation

{$R *.dfm}

procedure TFormColMgrMain.BtnAutoFormatClick(Sender: TObject);
var
  fldIndex, colIndex, i: Integer;
  CountNonEmpty, TotalRows: Integer;
  AFieldName: string;
  PercentFilled: Double;
  Bmk: TBookmark;
  Col: TColumn;
  CellText: string;
  MaxWidth, CellWidth: Integer;
  Canvas: TCanvas;
begin
  // Count total rows first
  TotalRows := 0;
  QryWB.DisableControls;
  Bmk := QryWB.GetBookmark;
  try
    QryWB.First;
    while not QryWB.Eof do
    begin
      Inc(TotalRows);
      QryWB.Next;
    end;
  finally
    if QryWB.BookmarkValid(Bmk) then
      QryWB.GotoBookmark(Bmk);
    QryWB.EnableControls;
  end;

  if TotalRows = 0 then
    Exit;  // avoid division by zero

  // Prepare for measuring text
  Canvas := GrdWB.Canvas;
  Canvas.Font := GrdWB.Font;

  HiddenFields.Clear;

  // Loop all fields
  for fldIndex := 0 to QryWB.FieldCount - 1 do
  begin
    AFieldName := QryWB.Fields[fldIndex].FieldName;

    // Find grid column
    colIndex := -1;
    for i := 0 to GrdWB.Columns.Count - 1 do
      if SameText(GrdWB.Columns[i].FieldName, AFieldName) then
      begin
        colIndex := i;
        Break;
      end;

    if colIndex = -1 then
      Continue;

    Col := GrdWB.Columns[colIndex];

    // Count non-empty rows
    CountNonEmpty := 0;
    QryWB.DisableControls;
    Bmk := QryWB.GetBookmark;
    try
      QryWB.First;
      while not QryWB.Eof do
      begin
        if (not QryWB.Fields[fldIndex].IsNull) and
           (Trim(QryWB.Fields[fldIndex].AsString) <> '') then
          Inc(CountNonEmpty);
        QryWB.Next;
      end;
    finally
      if QryWB.BookmarkValid(Bmk) then
        QryWB.GotoBookmark(Bmk);
      QryWB.EnableControls;
    end;

    // Calculate percentage
    PercentFilled := (CountNonEmpty / TotalRows) * 100.0;

    // Visibility rule
    if PercentFilled >= 1.0 then
      Col.Visible := True
    else
    begin
      Col.Visible := False;
      HiddenFields.Add(AFieldName);
    end;


    //--- AUTO-SIZE visible columns ---
//    if Col.Visible then
//    begin
//      MaxWidth := Canvas.TextWidth(Col.Title.Caption + '  '); // start with header width
//
//      QryWB.DisableControls;
//      Bmk := QryWB.GetBookmark;
//      try
//        QryWB.First;
//        while not QryWB.Eof do
//        begin
//          CellText := QryWB.Fields[fldIndex].DisplayText;
//          CellWidth := Canvas.TextWidth(CellText + '  ');
//          if CellWidth > MaxWidth then
//            MaxWidth := CellWidth;
//          QryWB.Next;
//        end;
//      finally
//        if QryWB.BookmarkValid(Bmk) then
//          QryWB.GotoBookmark(Bmk);
//        QryWB.EnableControls;
//      end;
//
//      // Add padding and limit max width
//      if MaxWidth > 400 then
//        MaxWidth := 400; // prevent excessive size
//
//      Col.Width := MaxWidth + 12; // little padding
//    end;
  end;
end;

procedure TFormColMgrMain.FormCreate(Sender: TObject);
begin
  HiddenFields := TStringList.Create;
  ConWB.Connected := True;
  QryWB.Open('select first 100 * from transactions t order by t."INDEX" desc');
  QryWB.IndexFieldNames := 'INDEX';
//  ShowMessage(QryWB.Fields[0].FieldName);
end;

procedure TFormColMgrMain.FormDestroy(Sender: TObject);
begin
  HiddenFields.Free;
  ConWB.Connected := False;
end;

procedure TFormColMgrMain.BtnShowFieldsClick(Sender: TObject);
var
  i: Integer;
begin
  // Clear previous content
  UnitPopup.Memo1.Clear;

  // If nothing hidden
  if HiddenFields.Count = 0 then
  begin
    UnitPopup.Memo1.Lines.Add('(No hidden fields)');
  end
  else
  begin
    // List all hidden fields
    for i := 0 to HiddenFields.Count - 1 do
      UnitPopup.Memo1.Lines.Add(HiddenFields[i]);
  end;

  // Show the popup window
  UnitPopup.ShowModal;
end;



function TFormColMgrMain.FindGridColumn(const AFieldName: string): Integer;
var
  i: Integer;
begin
  for i := 0 to GrdWB.Columns.Count - 1 do
    if SameText(GrdWB.Columns[i].FieldName, AFieldName) then
      Exit(i);

  Result := -1; // not found
end;


function TFormColMgrMain.GetTotalRows: Integer;
var
  Bmk: TBookmark;
begin
  Result := 0;

  QryWB.DisableControls;
  Bmk := QryWB.GetBookmark;
  try
    QryWB.First;
    while not QryWB.Eof do
    begin
      Inc(Result);
      QryWB.Next;
    end;
  finally
    // Restore original position if bookmark is still valid
    if QryWB.BookmarkValid(Bmk) then
      QryWB.GotoBookmark(Bmk);
    QryWB.FreeBookmark(Bmk);
    QryWB.EnableControls;
  end;
end;


function TFormColMgrMain.GetPercentFilled(FieldIndex: Integer): Double;
var
  CountNonEmpty, TotalRows: Integer;
  Bmk: TBookmark;
begin
  CountNonEmpty := 0;
  TotalRows := GetTotalRows;

  if TotalRows = 0 then
    Exit(0);

  QryWB.DisableControls;
  Bmk := QryWB.GetBookmark;
  try
    QryWB.First;
    while not QryWB.Eof do
    begin
      // Check if field has non-empty value
      if (not QryWB.Fields[FieldIndex].IsNull) and
         (Trim(QryWB.Fields[FieldIndex].AsString) <> '') then
        Inc(CountNonEmpty);
      QryWB.Next;
    end;
  finally
    if QryWB.BookmarkValid(Bmk) then
      QryWB.GotoBookmark(Bmk);
    QryWB.FreeBookmark(Bmk);
    QryWB.EnableControls;
  end;

  // Compute percentage as: (filled rows / total rows) × 100
  Result := (CountNonEmpty / TotalRows) * 100.0;
end;


end.
